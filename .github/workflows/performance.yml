name: Performance Tests (k6)

on:
  workflow_dispatch:
    inputs:
      scenario:
        description: 'Test scenario to run'
        required: true
        default: 'baseline'
        type: choice
        options:
          - baseline
          - load
          - stress
          - dataloader
          - all
      environment:
        description: 'Target environment'
        required: true
        default: 'ci'
        type: choice
        options:
          - ci
          - staging
  schedule:
    - cron: '0 2 * * *' # Nightly at 2 AM UTC

env:
  DOTNET_VERSION: '10.0.x'
  GRAPHQL_URL: 'http://localhost:5002/graphql'
  K6_ENV: 'ci'

jobs:
  performance-tests:
    name: k6 Performance Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: familyhub
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: Dev123!
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      rabbitmq:
        image: rabbitmq:3.12-management
        ports:
          - 5672:5672
          - 15672:15672

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore src/api/FamilyHub.sln

      - name: Build
        run: dotnet build src/api/FamilyHub.sln --no-restore --configuration Release

      - name: Start API in background
        working-directory: src/api/FamilyHub.Api
        env:
          ASPNETCORE_ENVIRONMENT: Test
          DOTNET_ENVIRONMENT: Test
          CI: 'true'
        run: |
          dotnet run --configuration Release --environment Test &
          echo "API starting in background..."

      - name: Wait for API Health
        run: |
          echo "Waiting for API to be healthy..."
          for i in {1..30}; do
            if curl -sf -X POST http://localhost:5002/graphql \
               -H "Content-Type: application/json" \
               -d '{"query":"{ __typename }"}' > /dev/null 2>&1; then
              echo "API is healthy after $i attempts!"
              exit 0
            fi
            echo "Attempt $i/30 - API not ready yet, waiting..."
            sleep 2
          done
          echo "API failed to start within 60 seconds"
          exit 1

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg \
            --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" \
            | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6
          k6 version

      - name: Create results directory
        run: mkdir -p tests/performance/results

      - name: Seed DataLoader Test Data
        if: contains(fromJSON('["dataloader", "all"]'), github.event.inputs.scenario) || github.event_name == 'schedule'
        env:
          PGPASSWORD: Dev123!
        run: |
          echo "Seeding DataLoader test data..."
          psql -h localhost -U postgres -d familyhub -f tests/performance/seed/dataloader-test-data.sql
          echo "DataLoader test data seeded successfully!"

      - name: Run Baseline Test
        if: github.event.inputs.scenario == 'baseline' || github.event.inputs.scenario == 'all' || github.event_name == 'schedule'
        working-directory: tests/performance
        run: |
          echo "Running baseline performance test..."
          k6 run scenarios/baseline.js --summary-export=results/baseline-summary.json
        continue-on-error: true

      - name: Run Load Test
        if: github.event.inputs.scenario == 'load' || github.event.inputs.scenario == 'all'
        working-directory: tests/performance
        run: |
          echo "Running load performance test..."
          k6 run scenarios/load.js --summary-export=results/load-summary.json
        continue-on-error: true

      - name: Run Stress Test
        if: github.event.inputs.scenario == 'stress' || github.event.inputs.scenario == 'all'
        working-directory: tests/performance
        run: |
          echo "Running stress performance test..."
          k6 run scenarios/stress.js --summary-export=results/stress-summary.json
        continue-on-error: true

      - name: Run DataLoader Benchmark Test
        if: github.event.inputs.scenario == 'dataloader' || github.event.inputs.scenario == 'all' || github.event_name == 'schedule'
        working-directory: tests/performance
        env:
          K6_ENV: ci
        run: |
          echo "Running DataLoader benchmark test..."
          echo "Expected improvements (ADR-011):"
          echo "  - Query count: 201 → ≤3 (67x reduction)"
          echo "  - Latency: p95 < 200ms"
          k6 run scenarios/dataloader.js --summary-export=results/dataloader-summary.json
        continue-on-error: true

      - name: Upload Performance Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-results-${{ github.run_number }}
          path: tests/performance/results/
          retention-days: 30

      - name: Generate Performance Summary
        if: always()
        env:
          # Safe: These come from controlled choice dropdowns, not free-form user input
          SCENARIO_INPUT: ${{ github.event.inputs.scenario }}
          ENV_INPUT: ${{ github.event.inputs.environment }}
          RUN_NUMBER: ${{ github.run_number }}
        run: |
          echo "## Performance Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run:** #${RUN_NUMBER}" >> $GITHUB_STEP_SUMMARY
          echo "**Scenario:** ${SCENARIO_INPUT:-baseline (scheduled)}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${ENV_INPUT:-ci}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Performance Targets" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Baseline | Load | Stress |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| p50 | < 50ms | < 200ms | < 500ms |" >> $GITHUB_STEP_SUMMARY
          echo "| p95 | < 150ms | < 500ms | < 1000ms |" >> $GITHUB_STEP_SUMMARY
          echo "| p99 | < 300ms | < 1000ms | < 3000ms |" >> $GITHUB_STEP_SUMMARY
          echo "| Error Rate | < 0.1% | < 1% | < 5% |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f tests/performance/results/baseline-summary.json ]; then
            echo "### Baseline Test Results" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            head -100 tests/performance/results/baseline-summary.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f tests/performance/results/load-summary.json ]; then
            echo "### Load Test Results" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            head -100 tests/performance/results/load-summary.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f tests/performance/results/stress-summary.json ]; then
            echo "### Stress Test Results" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            head -100 tests/performance/results/stress-summary.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f tests/performance/results/dataloader-summary.json ]; then
            echo "### DataLoader Benchmark Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Expected Performance (ADR-011):**" >> $GITHUB_STEP_SUMMARY
            echo "- Query count: ≤3 queries for 100 users with families (67x improvement)" >> $GITHUB_STEP_SUMMARY
            echo "- Latency: p95 < 200ms (42x improvement)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            head -100 tests/performance/results/dataloader-summary.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
