# Agent OS Validation Workflow
# Validates Agent OS profiles, standards, and skills on PR

name: Agent OS Validation

on:
  pull_request:
    paths:
      - 'agent-os/**'
      - '.claude/skills/**'
      - '.devcontainer/**'

jobs:
  validate-yaml:
    name: Validate YAML Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install yamllint
        run: pip install yamllint

      - name: Validate Agent OS profiles
        run: |
          echo "Validating Agent OS profiles..."
          yamllint -d relaxed agent-os/profiles/ || true

      - name: Validate Agent OS standards index
        run: |
          echo "Validating standards index..."
          yamllint -d relaxed agent-os/standards/index.yml || true

      - name: Validate spec templates
        run: |
          echo "Validating spec templates..."
          yamllint -d relaxed agent-os/specs/templates/ || true

      - name: Validate active specs
        run: |
          if [ -d "agent-os/specs/active" ] && [ "$(ls -A agent-os/specs/active 2>/dev/null)" ]; then
            echo "Validating active specs..."
            yamllint -d relaxed agent-os/specs/active/ || true
          else
            echo "No active specs to validate"
          fi

  validate-markdown:
    name: Validate Markdown Skills
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install markdownlint
        run: npm install -g markdownlint-cli2

      - name: Validate skill markdown files
        run: |
          echo "Validating Claude Code skills..."
          markdownlint-cli2 ".claude/skills/**/*.md" || true

      - name: Validate standards markdown files
        run: |
          echo "Validating standards documentation..."
          markdownlint-cli2 "agent-os/standards/**/*.md" || true

  validate-structure:
    name: Validate Directory Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required Agent OS directories
        run: |
          echo "Checking Agent OS directory structure..."

          required_dirs=(
            "agent-os/profiles/shared"
            "agent-os/profiles/modules"
            "agent-os/profiles/layers"
            "agent-os/standards"
            "agent-os/specs/templates"
          )

          for dir in "${required_dirs[@]}"; do
            if [ -d "$dir" ]; then
              echo "✓ $dir exists"
            else
              echo "✗ $dir missing"
              exit 1
            fi
          done

      - name: Check required skill directories
        run: |
          echo "Checking skills directory structure..."

          required_dirs=(
            ".claude/skills/backend"
            ".claude/skills/frontend"
            ".claude/skills/database"
            ".claude/skills/testing"
            ".claude/skills/workflows"
            ".claude/skills/meta"
          )

          for dir in "${required_dirs[@]}"; do
            if [ -d "$dir" ]; then
              echo "✓ $dir exists"
            else
              echo "✗ $dir missing"
              exit 1
            fi
          done

      - name: Check required files exist
        run: |
          echo "Checking required files..."

          required_files=(
            "agent-os/profiles/shared/base.yaml"
            "agent-os/standards/index.yml"
            ".claude/skills/meta/skill-manifest.json"
            ".claude/skills/README.md"
          )

          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "✓ $file exists"
            else
              echo "✗ $file missing"
              exit 1
            fi
          done

  validate-json:
    name: Validate JSON Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate skill manifest JSON
        run: |
          echo "Validating skill manifest..."
          if jq empty .claude/skills/meta/skill-manifest.json 2>/dev/null; then
            echo "✓ skill-manifest.json is valid JSON"
          else
            echo "✗ skill-manifest.json is invalid JSON"
            exit 1
          fi

      - name: Validate devcontainer.json
        run: |
          if [ -f ".devcontainer/devcontainer.json" ]; then
            echo "Validating devcontainer.json..."
            if jq empty .devcontainer/devcontainer.json 2>/dev/null; then
              echo "✓ devcontainer.json is valid JSON"
            else
              echo "✗ devcontainer.json is invalid JSON"
              exit 1
            fi
          fi
