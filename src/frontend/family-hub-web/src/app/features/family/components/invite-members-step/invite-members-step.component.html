<div class="space-y-6">
  <!-- Header Section -->
  <div class="flex flex-col items-center text-center space-y-4">
    <div class="p-4 bg-blue-50 rounded-full">
      <app-icon name="mail" size="lg" customClass="text-blue-600"></app-icon>
    </div>
    <div>
      <h2 class="text-xl font-semibold text-gray-900 mb-2">Invite Family Members</h2>
      <p class="text-gray-600">
        Invite family members to join your family. You can skip this step and invite members later from the dashboard.
      </p>
    </div>
  </div>

  <!-- Form Section -->
  <form [formGroup]="emailForm" (ngSubmit)="onSubmit()" class="space-y-6">
    <!-- Email Invitations Section -->
    <div>
      <div class="flex justify-between items-center mb-4">
        <label class="block text-sm font-medium text-gray-700">
          Email Invitations (Optional)
        </label>
        <span [class]="'text-sm font-medium ' + counterColorClass()">
          {{ invitationCount() }} of {{ 20 }} emails
        </span>
      </div>

      <!-- Email Rows -->
      <div formArrayName="invitations" class="space-y-3">
        @for (inviteGroup of emailInvitationControls.controls; track inviteGroup; let i = $index) {
          <div [formGroup]="inviteGroup" class="flex gap-2 items-start">
            <!-- Email Input (flex-1) -->
            <div class="flex-1">
              <app-input
                [id]="'email-' + i"
                type="email"
                formControlName="email"
                placeholder="email@example.com"
                [error]="getEmailError(i)"
                [ariaLabel]="'Email address ' + (i + 1)"
                [ariaRequired]="false"
              ></app-input>
            </div>

            <!-- Role Dropdown (w-40) -->
            <div class="w-40">
              <select
                formControlName="role"
                [id]="'role-' + i"
                [attr.aria-label]="'Role for ' + (inviteGroup.get('email')?.value || 'email ' + (i + 1))"
                class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm h-10"
              >
                @for (role of availableRoles; track role.value) {
                  <option [value]="role.value">{{ role.label }}</option>
                }
              </select>
            </div>

            <!-- Remove Button -->
            <button
              type="button"
              (click)="removeEmailInvitation(i)"
              [attr.aria-label]="'Remove ' + (inviteGroup.get('email')?.value || 'email ' + (i + 1))"
              class="flex items-center justify-center w-10 h-10 text-red-600 hover:text-red-800 hover:bg-red-50 rounded-md transition-colors"
            >
              <app-icon name="trash" size="sm"></app-icon>
            </button>
          </div>
        }
      </div>

      <!-- Add Button -->
      <div class="mt-4">
        <app-button
          type="button"
          variant="secondary"
          size="sm"
          [disabled]="!canAddMoreInvitations()"
          (click)="addEmailInvitation()"
          ariaLabel="Add another email invitation"
        >
          <app-icon name="plus" size="sm"></app-icon>
          <span class="ml-2">Add Another Email</span>
        </app-button>

        @if (!canAddMoreInvitations()) {
          <p class="text-sm text-amber-600 mt-2">
            Maximum 20 invitations reached. You can invite more members from the dashboard later.
          </p>
        }
      </div>

      <!-- Helper Text -->
      <p class="text-sm text-gray-500 mt-2">
        Each person will receive an email invitation to join your family.
      </p>
    </div>

    <!-- Message Field Section -->
    <div>
      <label for="invitation-message" class="block text-sm font-medium text-gray-700 mb-2">
        Invitation Message (Optional)
      </label>

      <textarea
        id="invitation-message"
        formControlName="message"
        rows="4"
        maxlength="500"
        placeholder="Add a personal message to your invitations..."
        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
        [class.border-red-300]="getMessageError()"
        [attr.aria-invalid]="getMessageError() ? 'true' : 'false'"
        [attr.aria-describedby]="getMessageError() ? 'message-error' : 'message-helper'"
      ></textarea>

      <!-- Message Error -->
      @if (getMessageError()) {
        <p id="message-error" class="text-sm text-red-600 mt-1">
          {{ getMessageError() }}
        </p>
      }

      <!-- Message Helper -->
      @if (!getMessageError()) {
        <p id="message-helper" class="text-sm text-gray-500 mt-1 flex justify-between">
          <span>This message will be included in all invitation emails.</span>
          <span [class]="getMessageCharCount() > 450 ? 'text-amber-600' : ''">
            {{ getMessageCharCount() }} / 500 characters
          </span>
        </p>
      }
    </div>

    <!-- Hidden submit button for Enter key handling -->
    <button type="submit" class="sr-only" aria-hidden="true" tabindex="-1"></button>
  </form>
</div>
