# Per-environment Docker Compose — parameterized via ${ENV_NAME}
# Each branch gets its own isolated stack with unique subdomains.
# Shared services (Keycloak, MailHog) are in docker-compose.shared.yml.
#
# Usage: ENV_NAME=feature-150-file-management docker compose -f infrastructure/docker-compose.env.yml up -d

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL — application database (isolated per environment)
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: familyhub
      POSTGRES_USER: familyhub
      POSTGRES_PASSWORD: familyhub
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U familyhub']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - internal

  # ---------------------------------------------------------------------------
  # pgAdmin — database administration
  # ---------------------------------------------------------------------------
  pgadmin:
    image: dpage/pgadmin4:latest
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@familyhub.dev
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_SERVER_JSON_FILE: /pgadmin4/servers.json
    volumes:
      - ./pgadmin/servers.json:/pgadmin4/servers.json:ro
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      postgres:
        condition: service_healthy
    labels:
      - 'traefik.enable=true'
      - 'traefik.docker.network=traefik-public'
      - 'traefik.http.routers.pgadmin-${ENV_NAME}.rule=Host(`pgadmin-${ENV_NAME}.dev.andrekirst.de`) || Host(`pgadmin-${ENV_NAME}.localhost`)'
      - 'traefik.http.routers.pgadmin-${ENV_NAME}.entrypoints=websecure'
      - 'traefik.http.routers.pgadmin-${ENV_NAME}.tls=true'
      - 'traefik.http.services.pgadmin-${ENV_NAME}.loadbalancer.server.port=80'
    networks:
      - internal
      - traefik-public

  # ---------------------------------------------------------------------------
  # API — .NET backend with hot-reload
  # ---------------------------------------------------------------------------
  api:
    user: '${DOCKER_UID:-1000}:${DOCKER_GID:-1000}'
    build:
      context: ${SRC_ROOT:-../src}
      dockerfile: FamilyHub.Api/Dockerfile
      target: dev
      network: host
      args:
        MCR_REGISTRY: ${MCR_REGISTRY:-mcr.microsoft.com/}
        BAGET_URL: ${BAGET_URL:-http://localhost:5555/v3/index.json}
        UID: ${DOCKER_UID:-1000}
        GID: ${DOCKER_GID:-1000}
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:5152
      ConnectionStrings__DefaultConnection: Host=postgres;Port=5432;Database=familyhub;Username=familyhub;Password=familyhub
      # Shared Keycloak — per-env realm
      Keycloak__Authority: http://keycloak:8080/realms/FamilyHub-${ENV_NAME}
      Keycloak__Issuers: https://auth.localhost:4443/realms/FamilyHub-${ENV_NAME},https://auth.dev.andrekirst.de:4443/realms/FamilyHub-${ENV_NAME}
      Keycloak__Audience: account
      CORS__Origins: https://${ENV_NAME}.dev.andrekirst.de:4443,https://${ENV_NAME}.localhost:4443
      # Shared MailHog — resolves via traefik-public network alias
      Email__Host: mailhog
      Email__Port: 1025
      App__FrontendUrl: https://${ENV_NAME}.dev.andrekirst.de:4443
      # Frontend config endpoint (served at /config, proxied same-origin)
      FrontendConfig__ApiUrl: https://${ENV_NAME}.localhost:4443/graphql
      FrontendConfig__KeycloakIssuer: https://auth.localhost:4443/realms/FamilyHub-${ENV_NAME}
      FrontendConfig__KeycloakClientId: familyhub-web
      FrontendConfig__AppUrl: https://${ENV_NAME}.localhost:4443
    volumes:
      - ${SRC_ROOT:-../src}:/src
    depends_on:
      postgres:
        condition: service_healthy
    labels:
      - 'traefik.enable=true'
      - 'traefik.docker.network=traefik-public'
      # Direct API subdomain (for GraphQL Playground, direct access)
      - 'traefik.http.routers.api-${ENV_NAME}.rule=Host(`api-${ENV_NAME}.dev.andrekirst.de`) || Host(`api-${ENV_NAME}.localhost`)'
      - 'traefik.http.routers.api-${ENV_NAME}.entrypoints=websecure'
      - 'traefik.http.routers.api-${ENV_NAME}.tls=true'
      # Same-origin proxy: API paths on frontend domain -> API (avoids CORS + TLS issues)
      # Matches /graphql, /api/*, /config, /health on the frontend hostname
      - 'traefik.http.routers.api-proxy-${ENV_NAME}.rule=(Host(`${ENV_NAME}.dev.andrekirst.de`) || Host(`${ENV_NAME}.localhost`)) && (PathPrefix(`/graphql`) || PathPrefix(`/api`) || Path(`/config`) || Path(`/health`))'
      - 'traefik.http.routers.api-proxy-${ENV_NAME}.entrypoints=websecure'
      - 'traefik.http.routers.api-proxy-${ENV_NAME}.tls=true'
      - 'traefik.http.routers.api-proxy-${ENV_NAME}.priority=200'
      - 'traefik.http.services.api-${ENV_NAME}.loadbalancer.server.port=5152'
    networks:
      - internal
      - traefik-public

  # ---------------------------------------------------------------------------
  # Frontend — Angular dev server with live reload
  # ---------------------------------------------------------------------------
  frontend:
    user: '${DOCKER_UID:-1000}:${DOCKER_GID:-1000}'
    build:
      context: ${SRC_ROOT:-../src}/frontend/family-hub-web
      dockerfile: Dockerfile
      target: dev
      network: host
      args:
        DOCKERHUB_REGISTRY: ${DOCKERHUB_REGISTRY:-}
        UID: ${DOCKER_UID:-1000}
        GID: ${DOCKER_GID:-1000}
    volumes:
      - ${SRC_ROOT:-../src}/frontend/family-hub-web:/app
      - frontend_node_modules:/app/node_modules
    depends_on:
      - api
    labels:
      - 'traefik.enable=true'
      - 'traefik.docker.network=traefik-public'
      - 'traefik.http.routers.fe-${ENV_NAME}.rule=Host(`${ENV_NAME}.dev.andrekirst.de`) || Host(`${ENV_NAME}.localhost`)'
      - 'traefik.http.routers.fe-${ENV_NAME}.entrypoints=websecure'
      - 'traefik.http.routers.fe-${ENV_NAME}.tls=true'
      - 'traefik.http.services.fe-${ENV_NAME}.loadbalancer.server.port=4200'
    networks:
      - internal
      - traefik-public

volumes:
  postgres_data:
  frontend_node_modules:
  pgadmin_data:

networks:
  internal:
    driver: bridge
  traefik-public:
    external: true
