# Per-environment Docker Compose — parameterized via ${ENV_NAME}
# Each branch gets its own isolated stack with unique subdomains.
# Usage: ENV_NAME=feature-121-sidebar docker compose -f infrastructure/docker-compose.env.yml up -d

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL — application database
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: familyhub
      POSTGRES_USER: familyhub
      POSTGRES_PASSWORD: familyhub
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U familyhub']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - internal

  # ---------------------------------------------------------------------------
  # PostgreSQL — Keycloak database
  # ---------------------------------------------------------------------------
  postgres-keycloak:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak
    volumes:
      - postgres_keycloak_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U keycloak']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - internal

  # ---------------------------------------------------------------------------
  # Keycloak — identity provider
  # ---------------------------------------------------------------------------
  keycloak:
    image: quay.io/keycloak/keycloak:23.0.4
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres-keycloak:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak
      KC_HOSTNAME_URL: https://kc-${ENV_NAME}.localhost:4443
      KC_HOSTNAME_ADMIN_URL: https://kc-${ENV_NAME}.localhost:4443
      KC_PROXY_HEADERS: xforwarded
      KC_HTTP_ENABLED: 'true'
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    entrypoint: /bin/bash
    command:
      - -c
      - |
        mkdir -p /opt/keycloak/data/import
        sed 's/__ENV_NAME__/${ENV_NAME}/g' /opt/keycloak/import-template/familyhub-realm.json > /opt/keycloak/data/import/familyhub-realm.json
        exec /opt/keycloak/bin/kc.sh start-dev --import-realm
    volumes:
      - ./keycloak/familyhub-realm-template.json:/opt/keycloak/import-template/familyhub-realm.json:ro
      - keycloak_data:/opt/keycloak/data
    depends_on:
      postgres-keycloak:
        condition: service_healthy
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.kc-${ENV_NAME}.rule=Host(`kc-${ENV_NAME}.localhost`)'
      - 'traefik.http.routers.kc-${ENV_NAME}.entrypoints=websecure'
      - 'traefik.http.routers.kc-${ENV_NAME}.tls=true'
      - 'traefik.http.services.kc-${ENV_NAME}.loadbalancer.server.port=8080'
    networks:
      - internal
      - traefik-public

  # ---------------------------------------------------------------------------
  # MailHog — email testing
  # ---------------------------------------------------------------------------
  mailhog:
    image: mailhog/mailhog:latest
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.mail-${ENV_NAME}.rule=Host(`mail-${ENV_NAME}.localhost`)'
      - 'traefik.http.routers.mail-${ENV_NAME}.entrypoints=websecure'
      - 'traefik.http.routers.mail-${ENV_NAME}.tls=true'
      - 'traefik.http.services.mail-${ENV_NAME}.loadbalancer.server.port=8025'
    networks:
      - internal
      - traefik-public

  # ---------------------------------------------------------------------------
  # pgAdmin — database administration
  # ---------------------------------------------------------------------------
  pgadmin:
    image: dpage/pgadmin4:latest
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@familyhub.dev
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_SERVER_JSON_FILE: /pgadmin4/servers.json
    volumes:
      - ./pgadmin/servers.json:/pgadmin4/servers.json:ro
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      postgres:
        condition: service_healthy
      postgres-keycloak:
        condition: service_healthy
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.pgadmin-${ENV_NAME}.rule=Host(`pgadmin-${ENV_NAME}.localhost`)'
      - 'traefik.http.routers.pgadmin-${ENV_NAME}.entrypoints=websecure'
      - 'traefik.http.routers.pgadmin-${ENV_NAME}.tls=true'
      - 'traefik.http.services.pgadmin-${ENV_NAME}.loadbalancer.server.port=80'
    networks:
      - internal
      - traefik-public

  # ---------------------------------------------------------------------------
  # API — .NET backend with hot-reload
  # ---------------------------------------------------------------------------
  api:
    build:
      context: ../src
      dockerfile: FamilyHub.Api/Dockerfile
      target: dev
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:5152
      ConnectionStrings__DefaultConnection: Host=postgres;Port=5432;Database=familyhub;Username=familyhub;Password=familyhub
      Keycloak__Authority: http://keycloak:8080/realms/FamilyHub
      Keycloak__Issuer: https://kc-${ENV_NAME}.localhost:4443/realms/FamilyHub
      Keycloak__Audience: account
      CORS__Origins: https://${ENV_NAME}.localhost:4443
      Email__Host: mailhog
      Email__Port: 1025
      App__FrontendUrl: https://${ENV_NAME}.localhost:4443
    volumes:
      - ../src:/src
    depends_on:
      postgres:
        condition: service_healthy
      keycloak:
        condition: service_started
    labels:
      - 'traefik.enable=true'
      # Direct API subdomain (for GraphQL Playground, direct access)
      - 'traefik.http.routers.api-${ENV_NAME}.rule=Host(`api-${ENV_NAME}.localhost`)'
      - 'traefik.http.routers.api-${ENV_NAME}.entrypoints=websecure'
      - 'traefik.http.routers.api-${ENV_NAME}.tls=true'
      # Same-origin proxy: /graphql on frontend domain → API (avoids CORS + TLS issues)
      - 'traefik.http.routers.api-proxy-${ENV_NAME}.rule=Host(`${ENV_NAME}.localhost`) && PathPrefix(`/graphql`)'
      - 'traefik.http.routers.api-proxy-${ENV_NAME}.entrypoints=websecure'
      - 'traefik.http.routers.api-proxy-${ENV_NAME}.tls=true'
      - 'traefik.http.routers.api-proxy-${ENV_NAME}.priority=100'
      - 'traefik.http.services.api-${ENV_NAME}.loadbalancer.server.port=5152'
    networks:
      - internal
      - traefik-public

  # ---------------------------------------------------------------------------
  # Frontend — Angular dev server with live reload
  # ---------------------------------------------------------------------------
  frontend:
    build:
      context: ../src/frontend/family-hub-web
      dockerfile: Dockerfile
      target: dev
    volumes:
      - ../src/frontend/family-hub-web:/app
      - frontend_node_modules:/app/node_modules
    depends_on:
      - api
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.fe-${ENV_NAME}.rule=Host(`${ENV_NAME}.localhost`)'
      - 'traefik.http.routers.fe-${ENV_NAME}.entrypoints=websecure'
      - 'traefik.http.routers.fe-${ENV_NAME}.tls=true'
      - 'traefik.http.services.fe-${ENV_NAME}.loadbalancer.server.port=4200'
    networks:
      - traefik-public

volumes:
  postgres_data:
  postgres_keycloak_data:
  keycloak_data:
  frontend_node_modules:
  pgadmin_data:

networks:
  internal:
    driver: bridge
  traefik-public:
    external: true
