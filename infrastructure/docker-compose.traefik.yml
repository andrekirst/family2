# Shared Traefik reverse proxy + package caching proxies — runs once, routes all environments
# Usage: docker compose -f infrastructure/docker-compose.traefik.yml up -d

services:
  traefik:
    image: traefik:v3.2
    restart: always
    ports:
      - '4000:4000' # HTTP (redirects to HTTPS)
      - '4443:4443' # HTTPS
      - '8888:8080' # Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic:/etc/traefik/dynamic:ro
      - ./certs:/certs:ro
    healthcheck:
      test: ['CMD', 'traefik', 'healthcheck']
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - traefik-public

  hub:
    image: nginx:alpine
    restart: always
    volumes:
      - ./traefik/hub:/usr/share/nginx/html:ro
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.hub.rule=Host(`hub.localhost`) || Host(`hub.dev.andrekirst.de`)'
      - 'traefik.http.routers.hub.entrypoints=websecure'
      - 'traefik.http.routers.hub.tls=true'
      - 'traefik.http.services.hub.loadbalancer.server.port=80'
    networks:
      - traefik-public

  # ---------------------------------------------------------------------------
  # Package caching proxies — shared across all environments
  # ---------------------------------------------------------------------------

  # npm caching proxy (Verdaccio)
  verdaccio:
    image: verdaccio/verdaccio:6
    restart: always
    ports:
      - '4873:4873'
    volumes:
      - fh-proxy-verdaccio:/verdaccio/storage
      - ./proxy/verdaccio/config.yaml:/verdaccio/conf/config.yaml:ro
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.verdaccio.rule=Host(`npm.localhost`) || Host(`npm.dev.andrekirst.de`)'
      - 'traefik.http.routers.verdaccio.entrypoints=websecure'
      - 'traefik.http.routers.verdaccio.tls=true'
      - 'traefik.http.services.verdaccio.loadbalancer.server.port=4873'
    networks:
      - traefik-public

  # NuGet caching proxy (BaGet)
  baget:
    image: loicsharma/baget:latest
    restart: always
    ports:
      - '5555:80'
    env_file:
      - ./proxy/baget/baget.env
    volumes:
      - fh-proxy-baget:/var/baget
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.baget.rule=Host(`nuget.localhost`) || Host(`nuget.dev.andrekirst.de`)'
      - 'traefik.http.routers.baget.entrypoints=websecure'
      - 'traefik.http.routers.baget.tls=true'
      - 'traefik.http.services.baget.loadbalancer.server.port=80'
    networks:
      - traefik-public

  # Docker Hub pull-through cache
  registry-dockerhub:
    image: registry:2
    restart: always
    ports:
      - '5001:5000'
    volumes:
      - fh-proxy-registry-dockerhub:/var/lib/registry
      - ./proxy/registry/dockerhub-config.yml:/etc/docker/registry/config.yml:ro
    networks:
      - traefik-public

  # Microsoft Container Registry pull-through cache
  registry-mcr:
    image: registry:2
    restart: always
    ports:
      - '5002:5000'
    volumes:
      - fh-proxy-registry-mcr:/var/lib/registry
      - ./proxy/registry/mcr-config.yml:/etc/docker/registry/config.yml:ro
    networks:
      - traefik-public

  # GitHub Container Registry pull-through cache
  registry-ghcr:
    image: registry:2
    restart: always
    ports:
      - '5003:5000'
    volumes:
      - fh-proxy-registry-ghcr:/var/lib/registry
      - ./proxy/registry/ghcr-config.yml:/etc/docker/registry/config.yml:ro
    networks:
      - traefik-public

volumes:
  fh-proxy-verdaccio:
    external: true
  fh-proxy-baget:
    external: true
  fh-proxy-registry-dockerhub:
    external: true
  fh-proxy-registry-mcr:
    external: true
  fh-proxy-registry-ghcr:
    external: true

networks:
  traefik-public:
    name: traefik-public
    driver: bridge
